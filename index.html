<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Ijazah hal. 2 | Nilai - Skrip 005 v11</title>
    <style>
        /* ================= SETTING KERTAS F4 ================= */
        @page { size: 215mm 330mm; margin: 0; }
        body { 
            margin: 0; padding: 0; background-color: #525659; 
            font-family: "Times New Roman", serif; 
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* ================= PANEL KONTROL (AESTHETIC V11) ================= */
        .control-panel {
            background: #fff; width: 215mm; margin: 20px auto;
            padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: block; box-sizing: border-box;
        }
        .control-panel h3 { margin: 0 0 15px; color: #007bff; font-family: Arial; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; }
        
        .row { display: flex; gap: 12px; margin-bottom: 15px; align-items: flex-start; }
        .group { display: flex; flex-direction: column; gap: 6px; }
        
        label { font-size: 11px; font-weight: bold; font-family: Arial; color: #444; text-transform: uppercase; white-space: nowrap; }
        
        /* Tinggi Seragam 40px untuk semua Box */
        input[type="text"], input[type="number"], input[type="date"], input[type="file"], select { 
            height: 40px; padding: 0 10px; border: 1px solid #ccc; border-radius: 4px; 
            font-size: 13px; box-sizing: border-box; width: 100%; font-family: Arial, sans-serif;
        }
        input[type="file"] { padding: 8px 10px; }

        /* Sinkronisasi Tinggi Hint agar Input Sejajar */
        .hint { font-size: 10px; color: #888; font-style: italic; min-height: 14px; font-family: Arial; line-height: 1.2; }

        /* Toggle Skala Nilai */
        .toggle-container { 
            display: flex; align-items: center; background: #f8f9fa; 
            padding: 0 12px; border-radius: 4px; border: 1px solid #ccc; 
            height: 40px; box-sizing: border-box;
        }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; margin: 0 10px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #28a745; }
        input:checked + .slider:before { transform: translateX(16px); }
        .status-text { font-size: 12px; font-weight: bold; color: #333; white-space: nowrap; }

        .btn-gen { width: 100%; padding: 15px; background: #28a745; color: #fff; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; font-size: 16px; margin-top: 5px; transition: 0.3s; }
        .btn-gen:hover { background: #218838; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        /* ================= KANVAS HALAMAN CETAK ================= */
        .page-canvas {
            width: 215mm; height: 330mm; margin: 10mm auto;
            background-color: white; position: relative;
            box-sizing: border-box; overflow: hidden;
            page-break-after: always;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .printable-area {
            position: absolute;
            top: 0.5cm; right: 0.5cm; bottom: 0.5cm; left: 0.7cm; 
            background-image: url('Border belakang.png');
            background-size: 100% 100%;
            background-repeat: no-repeat;
        }

        .content-overlay {
            position: relative; width: 100%; height: 100%;
            padding: 8cm 2cm 0 2cm; 
            box-sizing: border-box; display: flex; flex-direction: column;
        }
        
        .header-section { text-align: center; margin-bottom: 10px; }
        .main-title { font-size: 16pt; font-weight: bold; text-transform: uppercase; margin-bottom: 0px; letter-spacing: 1px; }
        .sub-title { font-size: 14pt; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; }
        .periode-title { font-size: 14pt; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }

        .identity-table { margin-left: 20px; margin-bottom: 8px; font-size: 12pt; font-weight: bold; }
        .identity-table td { padding: 2px 0; vertical-align: top; border: none; }
        .label-cell { width: 110px; }
        .sep-cell { width: 15px; text-align: center; }

        .table-container { margin-top: 5px; padding: 0 10px; }
        table.nilai-table { width: 100%; border-collapse: collapse; border: 2px solid #000; }
        table.nilai-table th { border: 1px solid #000; padding: 4px; font-size: 12pt; text-align: center; font-weight: bold; height: 32px; vertical-align: middle; }
        table.nilai-table td { border: 1px solid #000; padding: 3px 6px; font-size: 12pt; height: 24px; vertical-align: middle; }
        
        /* ALIGNMENT FIX */
        .col-no { width: 40px; text-align: center; }
        .col-materi { text-align: left; padding-left: 15px; }
        .col-angka { width: 100px; text-align: center !important; font-weight: bold; }
        .col-huruf { width: 250px; text-align: left; padding-left: 15px; font-style: italic; text-transform: capitalize; }

        .row-total { font-weight: bold; background-color: #f9f9f9; }
        .total-label { text-align: center; }

        .footer-wrapper {
            width: 8.0cm; margin-left: auto; margin-right: 10px; margin-top: 24pt;       
            display: flex; flex-direction: column; align-items: center;    
        }
        .date-row-combined { display: flex; flex-direction: row; align-items: center; justify-content: center; width: 100%; margin-bottom: 5px; }
        .kota-text { margin-right: 8px; font-size: 12pt; white-space: nowrap; }
        .date-stack { display: flex; flex-direction: column; align-items: center; font-size: 12pt; }
        .hr-divider { width: 100%; min-width: 160px; height: 0; border-bottom: 1px solid black; margin: 3px 0; }

        .sign-block { width: 100%; text-align: center; margin-top: 10px; }
        .jabatan { font-size: 12pt; font-weight: bold; margin-bottom: 2px; }
        .korcab { font-size: 12pt; font-weight: normal; margin-bottom: 75px; } 
        .pejabat { font-size: 12pt; font-weight: bold; text-decoration: underline; }

        .page-info { position: absolute; bottom: 5mm; right: 10mm; font-size: 9pt; color: #999; font-family: Arial; }

        @media print {
            body { background: none; padding: 0; }
            .control-panel { display: none !important; }
            .page-canvas { margin: 0; box-shadow: none; }
            .page-info { display: none !important; } 
        }
    </style>
</head>
<body>

<div class="control-panel">
    <h3>Ijazah hal. 2 | Nilai</h3>
    
    <div class="row">
        <div class="group" style="flex: 2;">
            <label>1. Judul Kegiatan / Nama Acara</label>
            <input type="text" id="cfg-event-name" value="EVALUASI BELAJAR TAHAP AKHIR QIROATI (EBTAQ)">
            <div class="hint">&nbsp;</div>
        </div>
        <div class="group" style="flex: 1.5;">
            <label>2. Upload file hasil penilaian</label>
            <input type="file" id="csv-input" accept=".csv, .xls" onchange="readCSV()">
            <div class="hint">Format file: .csv atau .xls</div>
        </div>
        <div class="group" style="flex: 1;">
            <label>3. Skala Nilai</label>
            <div class="toggle-container">
                <label class="switch">
                    <input type="checkbox" id="scale-toggle" onchange="updateToggleText()">
                    <span class="slider"></span>
                </label>
                <span class="status-text" id="toggle-status">Desimal</span>
            </div>
            <div class="hint">(satuan / puluhan)</div>
        </div>
    </div>

    <div class="row">
        <div class="group" style="flex: 0.8;">
            <label>4. Tgl Masehi</label>
            <input type="date" id="cfg-m-date">
            <div class="hint">&nbsp;</div>
        </div>
        <div class="group" style="flex: 0.8;">
            <label>5. Tgl Hijriah</label>
            <input type="number" id="cfg-h-date" placeholder="12">
            <div class="hint">&nbsp;</div>
        </div>
        <div class="group" style="flex: 1.5;">
            <label>6. Bulan Cerdas (Periode/Bulan)</label>
            <input type="text" id="cfg-smart-month" placeholder="Cth: Rojab atau Rojab / Sya'ban">
            <div class="hint">Input Tunggal atau Ganda (/)</div>
        </div>
        <div class="group" style="flex: 0.5;">
            <label>7. Tahun Hijriah</label>
            <input type="number" id="cfg-h-year" placeholder="1447" min="1447">
            <div class="hint">Min. 1447</div>
        </div>
    </div>

    <div class="row">
        <div class="group" style="flex: 1.5;">
            <label>8. Pilih Lembaga</label>
            <select id="sel-lembaga" disabled><option value="">-- Upload File Dulu --</option></select>
        </div>
        <div class="group">
            <label>9. Nama Penanggung Jawab</label>
            <input type="text" id="cfg-signer-name" placeholder="Ketua Pelaksana">
        </div>
        <div class="group">
            <label>10. Jabatan</label>
            <input type="text" id="cfg-signer-role" placeholder="Ketua Pelaksana EBTAQ">
        </div>
    </div>

    <button class="btn-gen" onclick="generate()">GENERATE HALAMAN NILAI</button>
</div>

<div id="output"></div>

<script>
    let dbCSV = [];
    const DEFAULT_ROLE = "Ketua Pelaksana EBTAQ";

    window.onload = () => {
        document.getElementById('cfg-m-date').value = new Date().toISOString().split('T')[0];
        const saved = JSON.parse(localStorage.getItem('ebtaq_005_v11_mem')) || {};
        if(saved.eventName) document.getElementById('cfg-event-name').value = saved.eventName;
        if(saved.smartMonth) document.getElementById('cfg-smart-month').value = saved.smartMonth;
        if(saved.hDate) document.getElementById('cfg-h-date').value = saved.hDate;
        if(saved.hYear) document.getElementById('cfg-h-year').value = saved.hYear;
        if(saved.signerName) document.getElementById('cfg-signer-name').value = saved.signerName;
        if(saved.signerRole) document.getElementById('cfg-signer-role').value = saved.signerRole;
        if(saved.scaleMode !== undefined) {
            document.getElementById('scale-toggle').checked = saved.scaleMode;
            updateToggleText();
        }
    };

    function updateToggleText() {
        const isPuluhan = document.getElementById('scale-toggle').checked;
        document.getElementById('toggle-status').innerText = isPuluhan ? "Puluhan (85)" : "Desimal (8.5)";
    }

    function readCSV() {
        const file = document.getElementById('csv-input').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const raw = e.target.result;
            const lines = raw.split(/\r?\n/).filter(l => l.trim() !== "");
            const delimiter = lines[0].includes(';') ? ';' : ','; 
            const headers = lines[0].split(delimiter).map(h => h.replace(/"/g, '').trim().toUpperCase());
            dbCSV = lines.slice(1).map(line => {
                const cols = line.split(delimiter).map(c => c.replace(/"/g, '').trim());
                let obj = {}; cols.forEach((v, i) => { if(headers[i]) obj[headers[i]] = v; });
                return obj;
            });
            const listLembaga = [...new Set(dbCSV.map(d => d['ASAL LEMBAGA']))].filter(x => x).sort();
            const sel = document.getElementById('sel-lembaga');
            sel.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
            listLembaga.forEach(l => sel.innerHTML += `<option value="${l}">${l}</option>`);
            sel.disabled = false;
            alert(`File Dimuat: ${dbCSV.length} Data Santri.`);
        };
        reader.readAsText(file);
    }

    function formatMasehiDate(ds) {
        if(!ds) return "";
        const b = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const d = new Date(ds); 
        return `${d.getDate()} ${b[d.getMonth()]} ${d.getFullYear()} M`;
    }

    // FUNGSI TERBILANG DENGAN PERBAIKAN SPASI RATUS & PULUH
    function terbilang(x) {
        const angka = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
        let n = Math.abs(x);
        let hasil = "";
        let intPart = Math.floor(n);
        let decPart = Math.round((n - intPart) * 100);

        if (intPart < 12) { hasil = " " + angka[intPart]; }
        else if (intPart < 20) { hasil = terbilang(intPart - 10) + " Belas "; }
        else if (intPart < 100) { hasil = terbilang(Math.floor(intPart / 10)) + " Puluh " + terbilang(intPart % 10); }
        else if (intPart < 200) { hasil = " Seratus " + terbilang(intPart - 100); }
        else if (intPart < 1000) { hasil = terbilang(Math.floor(intPart / 100)) + " Ratus " + terbilang(intPart % 100); }

        if (decPart > 0) {
             let decStr = n.toString().split('.')[1];
             if(decStr) { hasil += " Koma "; for(let char of decStr) { hasil += " " + angka[parseInt(char)] + " "; } }
        }
        // Bersihkan spasi ganda dan trim
        return hasil.replace(/\s+/g, ' ').trim();
    }

    function generate() {
        if (dbCSV.length === 0) return alert("Upload file penilaian dulu!");
        const targetLembaga = document.getElementById('sel-lembaga').value;
        if (!targetLembaga) return alert("Pilih Lembaga dulu!");

        const eventName = document.getElementById('cfg-event-name').value;
        const smartMonthRaw = document.getElementById('cfg-smart-month').value;
        const hDate = document.getElementById('cfg-h-date').value;
        const hYear = document.getElementById('cfg-h-year').value;
        const mDateRaw = document.getElementById('cfg-m-date').value;
        const signerName = document.getElementById('cfg-signer-name').value;
        let signerRole = document.getElementById('cfg-signer-role').value || DEFAULT_ROLE;
        const isPuluhan = document.getElementById('scale-toggle').checked;

        let periodName = smartMonthRaw; 
        let titiMonth = smartMonthRaw;  
        if (smartMonthRaw.includes('/')) {
            const parts = smartMonthRaw.split('/');
            periodName = parts[0].trim();
            titiMonth = parts[1].trim();
        }

        const fullTitimangsaH = `${hDate} ${titiMonth} ${hYear} H`;
        const fullTitimangsaM = formatMasehiDate(mDateRaw);

        localStorage.setItem('ebtaq_005_v11_mem', JSON.stringify({ eventName, smartMonth: smartMonthRaw, hDate, hYear, signerName, signerRole, scaleMode: isPuluhan }));

        const filteredData = dbCSV.filter(d => d['ASAL LEMBAGA'] === targetLembaga && (d['L / TL'] === 'L' || d['L/TL'] === 'L'));
        const totalPages = filteredData.length;
        const out = document.getElementById('output');
        out.innerHTML = "";

        const mapMateri = [
            { label: "Fashohah", key: "N. FSH" }, { label: "Tartil", key: "N. TRL" },
            { label: "Tajwid", key: "N. TJW" }, { label: "Ghorib", key: "N. GRB" },
            { label: "Hafalan Surat Pendek", key: "N. SSP" }, { label: "Do'a Harian", key: "N. DDH" },
            { label: "Praktek Sholat", key: "N. SLT" }, { label: "Praktek Wudlu'", key: "N. WDL" }
        ];

        filteredData.forEach((d, idx) => {
            let rawID = d['ID PESERTA'] || d['NO.'] || d['NO'] || d['NO IJAZAH'] || "0000";
            let sliceID = rawID.includes('.') ? rawID.split('.').pop() : rawID;
            const finalNoEbtaq = sliceID.padStart(4, '0');
            const namaSiswa = (d['NAMA LENGKAP'] || "").toUpperCase();

            let totalNilai = 0; let countMateri = 0; let rowsHTML = "";
            mapMateri.forEach((m, i) => {
                let valRaw = d[m.key] || "0";
                let valNum = parseFloat(valRaw.replace(',', '.'));
                let displayNum = isPuluhan ? Math.round(valNum * 10) : valNum;
                let textTerbilang = terbilang(displayNum);
                totalNilai += displayNum; countMateri++;
                let showVal = isPuluhan ? displayNum : displayNum.toString().replace('.', ',');
                rowsHTML += `<tr><td class="col-no">${i+1}.</td><td class="col-materi">${m.label}</td><td class="col-angka">${showVal}</td><td class="col-huruf">${textTerbilang}</td></tr>`;
            });

            let avg = totalNilai / countMateri;
            let avgRounded = Math.round(avg * 100) / 100;
            let showTotal = isPuluhan ? totalNilai : totalNilai.toString().replace('.', ',');
            let showAvg = avgRounded.toString().replace('.', ',');
            let textTotal = terbilang(totalNilai);
            let textAvg = terbilang(avgRounded);

            const page = document.createElement('div');
            page.className = 'page-canvas';
            page.innerHTML = `
                <div class="printable-area">
                    <div class="content-overlay">
                        <div class="header-section">
                            <div class="main-title">DAFTAR NILAI</div>
                            <div class="sub-title">${eventName}</div>
                            <div class="periode-title">PERIODE ${periodName} ${hYear} H / ${new Date(mDateRaw).getFullYear()} M</div>
                        </div>

                        <table class="identity-table">
                            <tr><td class="label-cell">No. EBTAQ</td><td class="sep-cell">:</td><td>${finalNoEbtaq}</td></tr>
                            <tr><td class="label-cell">Nama</td><td class="sep-cell">:</td><td>${namaSiswa}</td></tr>
                        </table>

                        <div class="table-container">
                            <table class="nilai-table">
                                <thead><tr><th>No</th><th>Materi Tashih</th><th>Nilai (Angka)</th><th>Nilai (Huruf)</th></tr></thead>
                                <tbody>
                                    ${rowsHTML}
                                    <tr class="row-total"><td colspan="2" class="total-label">Total Nilai</td><td class="col-angka">${showTotal}</td><td class="col-huruf">${textTotal}</td></tr>
                                    <tr class="row-total"><td colspan="2" class="total-label">Rata - Rata</td><td class="col-angka">${showAvg}</td><td class="col-huruf">${textAvg}</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="footer-wrapper">
                            <div class="date-row-combined">
                                <div class="kota-text">Demak,</div>
                                <div class="date-stack">
                                    <div>${fullTitimangsaH}</div>
                                    <div class="hr-divider"></div>
                                    <div>${fullTitimangsaM}</div>
                                </div>
                            </div>
                            <div class="sign-block">
                                <div class="jabatan">${signerRole}</div>
                                <div class="korcab">Korcab Qiroati Demak</div>
                                <div class="pejabat">${signerName}</div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="page-info">Halaman ${idx+1} dari ${totalPages}</div>`;
            out.appendChild(page);
        });
    }
</script>
</body>
</html>
